{% extends "store/layout.html" %}
{% load static %}

{% block content %}
    <div class="container">
    <table class="table">
        <thead>
        <tr>
          <th>Name</th>
          <th>Quantity</th>
          <th>Price</th>
          <th>Delete</th>
        </tr>
        </thead>
        <tbody>
          {% for i in products %}
              <tr id={{i.id}}>
                <td>{{ i.product.name }}</td>
                <td id={{i.id}}>
                    <span>{{ i.quantity }}</span>

                    <a href="#"><i id="up" class="arrow up"></i></a>
                    <a href="#"><i id="down" class="arrow down"></i></a>
                </td>
                <td>${{ i.get_total|floatformat:"2" }}</td>
                <td><a id="del" class="fa fa-trash fa-lg" href="#">D</a></td>
              </tr>
          {% endfor %}
        </tbody>
        </table>

        <a class="btn btn-outline-success" href="{% url 'checkout' %}">Checkout</a>


        <form id="payment-form" method="post" action="{% url 'checkout' %}">
            {% csrf_token %}
          <section>
            <label for="amount">
              <span class="input-label">Amount</span>
              <div class="input-wrapper amount-wrapper">
                <input id="amount" name="amount" type="tel" min="1" placeholder="Amount" value="10">
              </div>
            </label>

            <div class="bt-drop-in-wrapper">
              <div id="bt-dropin"></div>
            </div>
          </section>

          <input type="hidden" id="nonce" name="payment_method_nonce" />
          <button class="button" type="submit" id="submit-button"><span>Test Transaction</span></button>
        </form>

        </div>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://js.braintreegateway.com/web/dropin/1.23.0/js/dropin.min.js"></script>
        <script type="text/javascript">

            var form = document.querySelector('#payment-form');
             var client_token = '{{ client_token }}';

             braintree.dropin.create({
               authorization: client_token,
               container: '#bt-dropin',
               paypal: {
                 flow: 'vault'
               }
             }, function (createErr, instance) {
               form.addEventListener('submit', function (event) {
                 event.preventDefault();

                 instance.requestPaymentMethod(function (err, payload) {
                   if (err) {
                     console.log('Error', err);
                     return;
                   }

                   // Add the nonce to the form and submit
                   document.querySelector('#nonce').value = payload.nonce;
                   form.submit();
                 });
               });
             });


            const cartTable = document.getElementsByClassName("table")[0]

            // From Djang doc.
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            console.log(cartTable);
            let action = ''
            cartTable.addEventListener('click', function(e) {
                console.log(e.target.tagName);
                console.log(e.target.id);
                if (e.target.tagName === 'I') {
                        const parentDiv = e.target.parentElement.parentElement
                        const allChild = parentDiv.childNodes;
                        const parentDiv2 = e.target.parentElement.parentElement.parentElement

                        console.log(parentDiv2);
                        let price = parentDiv2.childNodes[5]
                        const id = parentDiv.id
                        let quantity = allChild[1];
                        let quantity_value = allChild[1].textContent
                        // console.log(quantity);
                        if (e.target.id === 'up') {
                            action = 'up'
                            quantity.innerHTML = 1 + parseInt(quantity_value)
                        }
                        if (e.target.id === 'down') {
                            if (quantity.innerHTML > 1) {
                                action = 'down'
                                quantity.innerHTML = parseInt(quantity_value) - 1
                            }
                        }

                        let total = quantity.innerHTML
                        console.log(total);
                        $.ajax({
                            type: "POST",
                            url: "/quantity",
                            headers: {
                                    'Content-Type':'application/json',
                                    'HTTP_X_REQUESTED_WITH':'XMLHttpRequest',
                                    'X-Requested-With':'XMLHttpRequest',
                                    'X-CSRFToken':getCookie('csrftoken'),
                                },
                            data: JSON.stringify({
                                  value: total,
                                  id: id,
                            }),
                            datatype:'json',
                            success: function(data) {
                              // if (data['success'])
                              price.innerHTML = "$" + data['total']

                            }
                        });
                        // const name = allChild[1].textContent;
                        // const price = allChild[9].textContent;

                }
                if (e.target.tagName === 'A' && e.target.id === 'del') {
                    // action = 'delete'
                    const row = e.target.parentElement.parentElement
                    const id = row.id

                    $.ajax({
                        type: "POST",
                        url: "/delete",
                        headers: {
                                'Content-Type':'application/json',
                                'HTTP_X_REQUESTED_WITH':'XMLHttpRequest',
                                'X-Requested-With':'XMLHttpRequest',
                                'X-CSRFToken':getCookie('csrftoken'),
                            },
                        data: JSON.stringify({
                              id: id,
                        }),
                        datatype:'json',
                        success: function(data) {
                          // if (data['success'])
                          // price.innerHTML = "$" + data['total']
                          // row.style.display = "none"
                          var fadeEffect = setInterval(function () {
                            if (!row.style.opacity) {
                                row.style.opacity = 1;
                            }
                            if (row.style.opacity > 0) {
                                row.style.opacity -= 0.1;
                            } else {
                                clearInterval(fadeEffect);
                                row.style.display = "none"
                            }
                        }, 200);


                        }
                    });
                }

            //     if (action !== '') {
            //         console.log(action);
            //     }
            //     action = ''
            })


        </script>


{% endblock content %}
